{% extends 'devices/base.html' %}
{% block title %}Navigate Ship - End{% endblock %}
{% block content %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    #map {
        height: 100vh;
        width: 100%;
    }
    .popup-content {
        max-width: 250px;
    }
    .popup-content h6 {
        color: #0d6efd;
        font-weight: bold;
    }
    .back-button {
        position: absolute;
        top: 10px;
        left: 10px;
        cursor: pointer;
        font-size: 1.5rem;
        color: #007bff;
    }
    .distance-label {
        position: absolute;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
</style>

<div id="map"></div>
<span id="back-button" class="back-button">‚Üê Back</span>
{% endblock content %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turf.js/6.5.0/turf.min.js"></script>
<script>
(function() {
    // Configuration
    const DEFAULT_VIEW = [20, 0];
    const DEFAULT_ZOOM = 2;
    const MARKER_ZOOM = 10;

    // Initialize Map
    const map = L.map('map').setView(DEFAULT_VIEW, DEFAULT_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Boat Icon Configuration
    const boatIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/3144/3144456.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16]
    });

    // Destination Icon Configuration
    const destinationIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/789/789445.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16]
    });

    // Get URL Parameters
    const params = new URLSearchParams(window.location.search);
    const startLat = parseFloat(params.get('start_lat'));
    const startLon = parseFloat(params.get('start_lon'));
    const endLat = parseFloat(params.get('end_lat'));
    const endLon = parseFloat(params.get('end_lon'));

    // Initialize Markers
    const startMarker = L.marker([startLat, startLon], { icon: boatIcon }).addTo(map);
    const endMarker = L.marker([endLat, endLon], { icon: destinationIcon }).addTo(map);

    // Draw Line
    const polyline = L.polyline([[startLat, startLon], [endLat, endLon]], { color: 'blue' }).addTo(map);

    // Calculate Distance
    const distance = turf.distance(turf.point([startLon, startLat]), turf.point([endLon, endLat]), { units: 'kilometers' }).toFixed(2);

    // Display Distance Label
    const distanceLabel = L.popup({ closeButton: false, autoClose: false, closeOnClick: false })
        .setLatLng([endLat, endLon])
        .setContent(`<strong>Distance:</strong> ${distance} km`)
        .openOn(map);

    // Zoom to Fit Both Points
    const bounds = L.latLngBounds([[startLat, startLon], [endLat, endLon]]);
    map.fitBounds(bounds, { padding: [50, 50] });

    // Back Button
    document.getElementById('back-button').addEventListener('click', function() {
        window.location.href = '{% url "navigate" %}';
    });
})();
</script>
{% endblock scripts %}