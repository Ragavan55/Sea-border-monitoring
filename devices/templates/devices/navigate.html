{% extends 'devices/base.html' %}
{% block title %}Navigate Ship{% endblock %}
{% block content %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    #map {
        height: 70vh;
        width: 100%;
        position: fixed;
        top: 60px;
        left: 0;
        display: none;
    }
    .form-container {
        margin-top: 20px;
    }
    .popup-content {
        max-width: 250px;
    }
    .popup-content h6 {
        color: #0d6efd;
        font-weight: bold;
    }
    .start-button {
        position: absolute;
        bottom: 20px;
        left: 40%;
        transform: translateX(-50%);
        display: none;
    }
    .load-button {
        position: absolute;
        bottom: 20px;
        left: 100%;
        transform: translateX(50%);
        display: none;
    }
    .cancel-button {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 1.5rem;
        color: #dc3545;
        display: none;
    }
    .distance-label {
        position: absolute;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: none;
    }
    .auth-buttons {
        margin-bottom: 20px;
        text-align: right;
    }
    .auth-buttons a {
        margin-left: 10px;
    }
</style>
<div class="auth-buttons">
    {% comment %} {% if not user.is_authenticated %}
        <a href="{% url 'login' %}" class="btn btn-primary">Login</a>
        <a href="{% url 'register' %}" class="btn btn-success">Sign Up</a>
    {% endif %} {% endcomment %}
</div>
<div class="form-container">
    <form id="ship-form" method="get">
        {% csrf_token %}
        <div class="mb-3">
            <label for="ship-name" class="form-label">Ship Name:</label>
            <input type="text" id="ship-name" name="ship_name" class="form-control" placeholder="Enter ship name" required>
        </div>
        <div class="mb-3">
            <label for="owner-name" class="form-label">Owner Name:</label>
            <input type="text" id="owner-name" name="owner_name" class="form-control" placeholder="Enter owner name" required>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
    {% if error %}
        <div class="alert alert-danger mt-3">{{ error }}</div>
    {% endif %}
</div>
<div id="map"></div>
<div id="distance-label" class="distance-label"></div>
<button id="start-button" class="btn btn-success start-button">Start</button>
<button id="load-button" class="btn btn-info start-button" style="display: none; margin-left: 10px;">Load</button>
<span id="cancel-button" class="cancel-button">Ã—</span>
{% endblock content %}
{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turf.js/6.5.0/turf.min.js"></script>
<script>
    (function () {
        const DEFAULT_VIEW = [20, 0];
        const DEFAULT_ZOOM = 2;
        const MARKER_ZOOM = 10;

        let map = null;
        let marker = null;
        let destinationMarker = null;
        let polyline = null;
        let distanceLabel = null;

        // Custom boat icon
        const boatIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3144/3144456.png', // Replace with your boat icon URL
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        });

        // Initialize the map
        function initializeMap(lat, lon) {
            if (!map) {
                map = L.map('map').setView([lat, lon], DEFAULT_ZOOM);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                // Add click event to select a location
                map.on('click', onMapClick);
            } else {
                map.setView([lat, lon], DEFAULT_ZOOM);
            }
        }

        // Handle form submission
        document.getElementById('ship-form').addEventListener('submit', async function (event) {
            event.preventDefault();
            const shipName = document.getElementById('ship-name').value;
        
            try {
                const response = await fetch(`/get_live_ship_location/?ship_name=${encodeURIComponent(shipName)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    alert(errorData.error || 'Failed to fetch ship data.');
                    return;
                }
        
                const data = await response.json();
                const { lat, lon, ship_name, owner, time } = data;
        
                // Validate data before using it
                if (!lat || !lon) {
                    alert('Invalid location data received.');
                    return;
                }
        
                // Show the map and initialize it
                document.getElementById('map').style.display = 'block';
                initializeMap(lat, lon);
        
                // Add or update the marker
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker([lat, lon], { icon: boatIcon }).addTo(map);
                marker.bindPopup(`
                    <strong>${ship_name}</strong><br>
                    Owner: ${owner}<br>
                    Latitude: ${lat.toFixed(4)}<br>
                    Longitude: ${lon.toFixed(4)}<br>
                    Last Updated: ${time}
                `).openPopup();
            } catch (error) {
                console.error('Error fetching ship data:', error);
                alert('An error occurred while fetching ship data.');
            }
        });

        // Handle map click to select a location
        function onMapClick(e) {
            const { lat, lng } = e.latlng;

            // Add or update the destination marker
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
            }
            destinationMarker = L.marker([lat, lng], { draggable: true }).addTo(map);
            destinationMarker.bindPopup(`
                <strong>Selected Location</strong><br>
                Latitude: ${lat.toFixed(4)}<br>
                Longitude: ${lng.toFixed(4)}
            `).openPopup();

            // Show the "Start" and "Load" buttons
            document.getElementById('start-button').style.display = 'block';
            document.getElementById('load-button').style.display = 'block';

            // Log the selected location (or send it to the backend if needed)
            console.log('Selected Location:', { lat, lng });
        }

        // Handle "Start" button click
        document.getElementById('start-button').addEventListener('click', function () {
            if (!marker || !destinationMarker) {
                alert('Please select a destination first.');
                return;
            }

            const startLatLng = marker.getLatLng();
            const endLatLng = destinationMarker.getLatLng();

            // Draw a line between the current and destination points
            if (polyline) {
                map.removeLayer(polyline);
            }
            polyline = L.polyline([startLatLng, endLatLng], { color: 'blue' }).addTo(map);

            // Calculate and display the distance
            const distance = map.distance(startLatLng, endLatLng) / 1000; // Convert to kilometers
            if (distanceLabel) {
                map.removeLayer(distanceLabel);
            }
            distanceLabel = L.popup({
                closeButton: false,
                autoClose: false,
                closeOnClick: false
            })
                .setLatLng(startLatLng)
                .setContent(`<strong>Distance:</strong> ${distance.toFixed(2)} km`)
                .openOn(map);
        });

        // Handle "Load" button click
        document.getElementById('load-button').addEventListener('click', async function () {
            if (!marker || !destinationMarker) {
                alert('Please select a destination first.');
                return;
            }

            const endLatLng = destinationMarker.getLatLng();
            const startLatLng = marker.getLatLng();
            const distance = map.distance(startLatLng, endLatLng) / 1000; // Convert to kilometers

            // Send data to ThingSpeak
            const writeApiKey = 'ZNQZU1IVWAUQ5M16'; // Replace with your ThingSpeak write API key
            const url = `https://api.thingspeak.com/update?api_key=${writeApiKey}&field4=${endLatLng.lat}&field5=${endLatLng.lng}&field6=${distance.toFixed(2)}`;

            try {
                const response = await fetch(url, { method: 'GET' });
                if (response.ok) {
                    alert('Data successfully sent to ThingSpeak.');
                } else {
                    alert('Failed to send data to ThingSpeak.');
                }
            } catch (error) {
                console.error('Error sending data to ThingSpeak:', error);
                alert('An error occurred while sending data to ThingSpeak.');
            }
        });
    })();
</script>
{% endblock scripts %}